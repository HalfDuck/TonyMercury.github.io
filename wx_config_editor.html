<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>WX 配置编辑器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f172a;
      --bg-secondary: #111c32;
      --bg-tertiary: #152344;
      --accent: #38bdf8;
      --accent-muted: rgba(56, 189, 248, 0.15);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --border: #1e293b;
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.07), transparent 55%),
                  radial-gradient(circle at bottom, rgba(59, 130, 246, 0.05), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      backdrop-filter: blur(12px);
      background: rgba(15, 23, 42, 0.8);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 1rem 2rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem 2rem;
    }

    header h1 {
      font-size: 1.5rem;
      margin: 0;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .actions {
      display: flex;
      gap: 0.75rem;
      margin-left: auto;
      flex-wrap: wrap;
      align-items: center;
    }

    button, .tab {
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
      border-radius: 12px;
      padding: 0.55rem 1.25rem;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      line-height: 1.2;
    }

    button:hover, .tab:hover {
      background: rgba(56, 189, 248, 0.18);
      border-color: rgba(56, 189, 248, 0.35);
      transform: translateY(-1px);
    }

    button.primary {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.8), rgba(59, 130, 246, 0.8));
      border-color: rgba(56, 189, 248, 0.6);
      color: #0f172a;
    }

    button.danger {
      background: rgba(239, 68, 68, 0.18);
      border-color: rgba(239, 68, 68, 0.4);
      color: #fecaca;
    }

    main {
      padding: 2rem;
      display: grid;
      gap: 1.5rem;
    }

    .tabbar {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .tab.active {
      background: rgba(56, 189, 248, 0.35);
      border-color: rgba(56, 189, 248, 0.6);
      color: #0f172a;
    }

    .search-input {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 9999px;
      padding: 0.45rem 1.1rem;
      color: var(--text);
      font-size: 0.9rem;
      min-width: 220px;
      transition: border 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .search-input::placeholder {
      color: var(--text-muted);
      letter-spacing: 0.05em;
    }

    .search-input:focus {
      background: rgba(15, 23, 42, 0.85);
      border-color: rgba(56, 189, 248, 0.6);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.12);
      outline: none;
    }

    section {
      display: none;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.75rem;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
    }

    section.active {
      display: block;
    }

    h2 {
      margin-top: 0;
      margin-bottom: 1.25rem;
      font-size: 1.25rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #bae6fd;
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    .two-col {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .card {
      background: var(--bg-tertiary);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 16px;
      padding: 1rem;
      display: grid;
      gap: 0.75rem;
      position: relative;
    }

    .group-meta {
      display: grid;
      gap: 0.75rem;
      margin: 0.75rem 0;
    }

    .group-meta label {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    input, textarea, select {
      background: var(--bg-secondary);
      color: var(--text);
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: 10px;
      padding: 0.6rem 0.75rem;
      font-family: inherit;
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.6);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.12);
    }

    textarea {
      min-height: 140px;
      resize: vertical;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }

    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      font-size: 0.9rem;
    }

    th {
      text-align: left;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(56, 189, 248, 0.12);
      color: #bae6fd;
      border-radius: 9999px;
      padding: 0.35rem 0.8rem;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .group-list {
      display: grid;
      gap: 1rem;
    }

    .group-card {
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.8);
      padding: 1rem;
      display: grid;
      gap: 0.75rem;
      position: relative;
    }

    .group-header {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .group-header input {
      flex: 1;
      font-weight: 600;
    }

    .muted-btn {
      background: rgba(15, 23, 42, 0.35);
      border-color: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
    }

    .card form button {
      align-self: flex-start;
    }

    .endpoint-config {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      min-width: 220px;
    }

    .endpoint-config input {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 10px;
      padding: 0.45rem 0.75rem;
      color: var(--text);
      font-size: 0.85rem;
    }

    .endpoint-config input:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.6);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.12);
      background: rgba(15, 23, 42, 0.8);
    }

    header .actions button {
      align-self: center;
    }

    header .actions .endpoint-config {
      align-self: center;
    }

    .status-bar {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      min-width: 260px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.4);
      display: grid;
      gap: 0.35rem;
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .status-bar.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .status-title {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #38bdf8;
      font-size: 0.8rem;
    }

    .status-message {
      font-size: 0.9rem;
      color: var(--text);
    }

    .scroll-tools {
      position: fixed;
      right: 1.5rem;
      bottom: 7.5rem;
      display: grid;
      gap: 0.6rem;
      z-index: 18;
    }

    .scroll-tools button {
      border-radius: 12px;
      padding: 0.55rem 1.1rem;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 1.5rem;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 18px;
      width: min(460px, 100%);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1.5rem;
      box-shadow: 0 20px 60px rgba(2, 6, 23, 0.65);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.15rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.6rem;
      cursor: pointer;
      line-height: 1;
      padding: 0.15rem;
      border-radius: 8px;
    }

    .modal-close:hover {
      background: rgba(56, 189, 248, 0.12);
      color: #bae6fd;
    }

    .modal-body {
      display: grid;
      gap: 0.85rem;
      overflow-y: auto;
      padding-right: 0.25rem;
    }

    .modal-body label {
      display: grid;
      gap: 0.4rem;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .modal-body textarea {
      min-height: 110px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .input-error {
      border-color: rgba(248, 113, 113, 0.6) !important;
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.18) !important;
    }

    .error-hint {
      font-size: 0.75rem;
      color: #fca5a5;
      letter-spacing: 0.04em;
      min-height: 0.75rem;
    }

    .rule-card {
      display: grid;
      gap: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: 14px;
      padding: 1rem;
      background: rgba(17, 28, 50, 0.85);
    }

    .rule-conditions {
      display: grid;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.6);
    }

    .condition-row {
      display: grid;
      gap: 0.6rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .query-grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin-bottom: 0.75rem;
    }

    .flex {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .scroll {
      overflow: auto;
      max-height: 60vh;
      padding-right: 0.25rem;
    }

    .small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    @media (max-width: 900px) {
      header {
        padding: 1rem;
      }

      main {
        padding: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>WX CONFIG • 暗色编辑面板</h1>
    <div class="actions">
      <label class="endpoint-config">
        API 地址
        <input id="apiHostInput" placeholder="http://127.0.0.1:5000" />
      </label>
      <button id="reloadBtn" class="muted-btn">重新加载</button>
      <button id="validateBtn" class="muted-btn">校验配置</button>
      <button id="saveBtn" class="primary">保存配置</button>
    </div>
  </header>

  <main>
    <div class="tabbar">
      <button class="tab active" data-tab="overview">概览</button>
      <button class="tab" data-tab="level3">三级指标</button>
      <button class="tab" data-tab="cpt">条件概率 (CPT)</button>
      <button class="tab" data-tab="rules">规则</button>
      <button class="tab" data-tab="overrides">威胁等级标注</button>
      <button class="tab" data-tab="weights">权重</button>
      <button class="tab" data-tab="calibration">校准/阈值</button>
      <button class="tab" data-tab="meta">元信息</button>
    </div>

    <section id="overview" class="active">
      <div class="section-header">
        <h2>配置概览</h2>
        <input type="search" id="overviewSearch" class="search-input" placeholder="搜索概览或快照..." />
      </div>
      <div class="grid two-col">
        <div class="card">
          <h2>配置摘要</h2>
          <div id="overviewSummary" class="grid" style="gap:0.5rem"></div>
        </div>
        <div class="card">
          <h2>版本快照</h2>
          <div class="grid" style="gap:0.5rem">
            <div class="flex" style="align-items:center;justify-content:space-between">
              <span class="chip">服务器状态</span>
              <button id="loadVersions" class="muted-btn" style="padding:0.5rem 1rem">刷新版本</button>
            </div>
            <div id="versionList" class="scroll" style="max-height:280px"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="level3">
      <div class="section-header">
        <h2>三级指标权重</h2>
        <div class="flex" style="align-items:center;gap:0.75rem">
          <input type="search" id="level3Search" class="search-input" placeholder="搜索指标组或指标..." />
          <button id="addLevel3Group" class="muted-btn">新增指标组</button>
        </div>
      </div>
      <div id="level3Container" class="group-list"></div>
    </section>

    <section id="cpt">
      <div class="section-header">
        <h2>条件概率 (CPT)</h2>
        <div class="flex" style="align-items:center;gap:0.75rem">
          <input type="search" id="cptSearch" class="search-input" placeholder="搜索 CPT 键或内容..." />
          <button id="addCptEntry" class="muted-btn">新增 CPT 条目</button>
        </div>
      </div>
      <div id="cptContainer" class="grid" style="gap:1rem"></div>
    </section>

    <section id="rules">
      <div class="section-header">
        <h2>规则编辑</h2>
        <div class="flex" style="align-items:center;gap:0.75rem">
          <input type="search" id="rulesSearch" class="search-input" placeholder="搜索规则名称或条件..." />
          <button id="addRule" class="muted-btn">新增规则</button>
        </div>
      </div>
      <div id="rulesContainer" class="grid" style="gap:1rem"></div>
    </section>

    <section id="overrides">
      <div class="section-header">
        <h2>威胁等级标注</h2>
        <input type="search" id="overrideSearch" class="search-input" placeholder="搜索标注或威胁结果..." />
      </div>
      <div class="grid two-col">
        <div class="card">
          <h3 class="chip">单条标注</h3>
          <form id="overrideSingleForm" class="grid" style="gap:0.75rem">
            <div class="flex" style="align-items:flex-end">
              <label style="flex:1">
                标识类型
                <select id="overrideIdType">
                  <option value="mbPh">mbPh</option>
                  <option value="mbnm">mbnm</option>
                </select>
              </label>
              <label style="flex:2">
                标识值
                <input id="overrideIdValue" required placeholder="如 3250033 或 M123" />
              </label>
            </div>
            <div class="flex">
              <label style="flex:1">威胁等级<input id="overrideThreatLevel" required placeholder="如 5" /></label>
              <label style="flex:1">操作员<input id="overrideBy" placeholder="如 admin_A" /></label>
            </div>
            <label>理由<textarea id="overrideReason" placeholder="填写标注原因"></textarea></label>
            <button type="submit" class="primary">提交单条标注</button>
          </form>
        </div>
        <div class="card">
          <h3 class="chip">批量写入</h3>
          <form id="overrideBatchForm" class="grid" style="gap:0.75rem">
            <label>JSON 数组<textarea id="overrideBatchInput" placeholder='[{"mbPh":111,"threat_level":"4"}]'></textarea></label>
            <button type="submit" class="muted-btn">提交批量标注</button>
          </form>
        </div>
        <div class="card">
          <h3 class="chip">删除 / 清空</h3>
          <form id="overrideDeleteForm" class="grid" style="gap:0.75rem">
            <div class="flex" style="align-items:flex-end">
              <label style="flex:1">
                标识类型
                <select id="overrideDeleteType">
                  <option value="mbPh">mbPh</option>
                  <option value="mbnm">mbnm</option>
                </select>
              </label>
              <label style="flex:2">
                标识值
                <input id="overrideDeleteValue" placeholder="填写要删除的标注目标" />
              </label>
            </div>
            <button type="submit" class="danger">删除该标注</button>
          </form>
          <button id="overrideResetBtn" class="danger" style="margin-top:0.5rem">一键清空全部标注</button>
        </div>
        <div class="card">
          <h3 class="chip">标注统计</h3>
          <button id="refreshOverrideStats" class="muted-btn">刷新统计</button>
          <div id="overrideStatsBox" class="grid" style="gap:0.5rem"></div>
        </div>
        <div class="card">
          <h3 class="chip">单条查询</h3>
          <form id="overrideLookupForm" class="grid" style="gap:0.75rem">
            <div class="flex" style="align-items:flex-end">
              <label style="flex:1">
                标识类型
                <select id="overrideLookupType">
                  <option value="mbPh">mbPh</option>
                  <option value="mbnm">mbnm</option>
                </select>
              </label>
              <label style="flex:2">
                标识值
                <input id="overrideLookupValue" placeholder="输入要查询的标识" />
              </label>
            </div>
            <button type="submit" class="muted-btn">查询单条标注</button>
          </form>
          <div id="overrideLookupResult" class="grid" style="gap:0.5rem"></div>
        </div>
        <div class="card" style="grid-column:1 / -1">
          <div class="section-header" style="padding:0">
            <h3 class="chip">标注列表查询</h3>
            <div class="flex" style="align-items:center;gap:0.75rem">
              <span class="small" id="overrideQueryMeta"></span>
              <div class="flex" style="gap:0.5rem">
                <button form="overrideQueryForm" type="submit" class="muted-btn">执行查询</button>
                <button id="overrideExportBtn" class="muted-btn" type="button">导出</button>
              </div>
            </div>
          </div>
          <form id="overrideQueryForm" class="query-grid">
            <label>
              威胁等级
              <input id="overrideQueryLevel" placeholder="如 5" />
            </label>
            <label>
              操作员
              <input id="overrideQueryBy" placeholder="如 admin_A" />
            </label>
            <label>
              搜索
              <input id="overrideQueryTerm" placeholder="标识、理由或其他" />
            </label>
            <label>
              Limit
              <input id="overrideQueryLimit" type="number" min="1" step="1" />
            </label>
            <label>
              Offset
              <input id="overrideQueryOffset" type="number" min="0" step="1" />
            </label>
          </form>
          <div id="overrideQueryResults" class="grid" style="gap:0.75rem"></div>
        </div>
        <div class="card" style="grid-column:1 / -1">
          <div class="section-header" style="padding:0">
            <h3 class="chip">/calculate 响应记录</h3>
            <div class="flex" style="align-items:center;gap:0.75rem">
              <span class="small" id="overrideTotalLabel">已知标注总数：0</span>
              <button id="clearOverrideHistory" class="muted-btn">清空本地记录</button>
            </div>
          </div>
          <div id="overrideHistoryList" class="grid" style="gap:0.75rem"></div>
        </div>
        <div class="card" style="grid-column:1 / -1">
          <div class="section-header" style="padding:0">
            <h3 class="chip">威胁结果检查</h3>
            <button id="parseOverridePreview" class="muted-btn">解析结果</button>
          </div>
          <textarea id="overridePreviewInput" placeholder="粘贴 /calculate 返回的威胁结果 JSON"></textarea>
          <div id="overridePreviewOutput" class="grid" style="gap:0.75rem"></div>
        </div>
      </div>
    </section>

    <section id="weights">
      <div class="section-header">
        <h2>权重 • Level1 / Level2</h2>
        <input type="search" id="weightsSearch" class="search-input" placeholder="搜索 Level1 或 Level2 权重..." />
      </div>
      <div class="grid two-col">
        <div class="card">
          <h3 class="chip">Level 1</h3>
          <div id="level1Weights" class="grid" style="gap:0.75rem"></div>
        </div>
        <div class="card">
          <h3 class="chip">Level 2</h3>
          <div id="level2Weights" class="grid" style="gap:1rem"></div>
        </div>
      </div>
    </section>

    <section id="calibration">
      <div class="section-header">
        <h2>校准 & 阈值</h2>
        <input type="search" id="calibrationSearch" class="search-input" placeholder="搜索校准键或阈值..." />
      </div>
      <div class="grid two-col">
        <div class="card">
          <h3 class="chip">Calibration</h3>
          <div id="calibrationContainer" class="grid" style="gap:0.75rem"></div>
        </div>
        <div class="card">
          <h3 class="chip">Thresholds</h3>
          <div id="thresholdsContainer" class="grid" style="gap:0.75rem"></div>
          <button id="addThreshold" class="muted-btn" style="margin-top:0.5rem">新增阈值</button>
        </div>
      </div>
    </section>

    <section id="meta">
      <div class="section-header">
        <h2>元信息</h2>
        <input type="search" id="metaSearch" class="search-input" placeholder="搜索备注或单位..." />
      </div>
      <div class="grid two-col">
        <div class="card">
          <h3 class="chip">Meta</h3>
          <div id="metaSearchHint" class="small"></div>
          <label>
            Notes
            <textarea id="metaNotes"></textarea>
          </label>
          <label>
            Version
            <input id="metaVersion" />
          </label>
          <label>
            Updated At
            <input id="metaUpdated" />
          </label>
        </div>
        <div class="card">
          <h3 class="chip">Units</h3>
          <div id="metaUnits" class="grid" style="gap:0.75rem"></div>
          <button id="addUnit" class="muted-btn" style="margin-top:0.5rem">新增单位</button>
        </div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button type="button" id="modalClose" class="modal-close" aria-label="关闭">×</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
      <div class="modal-actions">
        <button type="button" id="modalCancel" class="muted-btn">取消</button>
        <button type="button" id="modalConfirm" class="primary">确定</button>
      </div>
    </div>
  </div>

  <div class="scroll-tools">
    <button id="scrollTopBtn" class="muted-btn">↑ 回到顶部</button>
    <button id="scrollBottomBtn" class="muted-btn">↓ 回到底部</button>
  </div>

  <div id="statusBar" class="status-bar">
    <span class="status-title" id="statusTitle"></span>
    <span class="status-message" id="statusMessage"></span>
  </div>

  <template id="level3GroupTemplate">
    <div class="group-card">
      <div class="group-header">
        <input class="group-name" />
        <button class="muted-btn rename-group">重命名</button>
        <button class="danger delete-group">删除</button>
      </div>
      <div class="group-meta">
        <label>
          所属一级分类
          <select class="group-parent"></select>
        </label>
        <label>
          二级权重
          <input type="number" step="0.01" class="parent-weight" />
        </label>
      </div>
      <div class="metrics"></div>
      <button class="muted-btn add-metric" style="align-self:flex-start">新增指标</button>
    </div>
  </template>

  <template id="metricRowTemplate">
    <div class="flex" style="align-items:flex-end">
      <label style="flex:1">
        指标名称
        <input class="metric-name" />
      </label>
      <label style="width:140px">
        权重
        <input type="number" step="0.01" class="metric-value" />
      </label>
      <button class="danger delete-metric" style="height:40px">删除</button>
    </div>
  </template>

  <script>
    const API_PATHS = {
      config: '/api/wx/config',
      versions: '/api/wx/config/versions',
      restore: '/api/wx/config/restore',
      validate: '/api/wx/config/validate',
      calculate: '/calculate',
      overrides: '/api/overrides',
      overrideStats: '/api/overrides/stats',
      overrideExport: '/api/overrides/export'
    };
    const HOST_STORAGE_KEY = 'wx_config_editor_host';
    const hostInput = document.getElementById('apiHostInput');
    let lastHostValue = '';
    let configData = null;
    const searchFilters = {
      overview: '',
      level3: '',
      cpt: '',
      rules: '',
      overrides: '',
      weights: '',
      calibration: '',
      meta: ''
    };
    let versionCache = [];
    let overrideLog = [];
    let overridePreviewData = [];
    let overrideTotalCount = 0;
    let overrideListResults = [];
    let overrideListMeta = {};
    let overrideListLoading = false;
    let overrideListError = '';
    let overrideStatsData = null;
    let overrideStatsLoading = false;
    let overrideStatsError = '';
    let overrideLookupData = null;
    let overrideLookupLoading = false;
    let overrideLookupError = '';
    let overrideListInitialized = false;
    const overrideQueryDefaults = Object.freeze({level: '', by: '', q: '', limit: 50, offset: 0});
    let overrideQueryParams = {...overrideQueryDefaults};
    const MAX_OVERRIDE_LOG = 80;

    const qs = (sel, parent = document) => parent.querySelector(sel);
    const qsa = (sel, parent = document) => Array.from(parent.querySelectorAll(sel));
    const RULE_OPERATORS = Object.freeze([
      '==',
      '!=',
      '>',
      '>=',
      '<',
      '<=',
      'in',
      'not_in',
      'contains',
      'contains_any',
      'contains_all',
      'starts_with',
      'ends_with',
      'matches',
      'between',
      'regex',
      'has',
      'missing'
    ]);

    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitleEl = document.getElementById('modalTitle');
    const modalBodyEl = document.getElementById('modalBody');
    const modalConfirmBtn = document.getElementById('modalConfirm');
    const modalCancelBtn = document.getElementById('modalCancel');
    const modalCloseBtn = document.getElementById('modalClose');

    function openFormModal({title = '', fields = [], confirmText = '确定'} = {}) {
      if (!modalOverlay || !modalTitleEl || !modalBodyEl) {
        return Promise.resolve(null);
      }
      return new Promise((resolve) => {
        modalTitleEl.textContent = title;
        modalConfirmBtn.textContent = confirmText;
        modalBodyEl.innerHTML = '';
        modalOverlay.classList.add('show');
        modalOverlay.setAttribute('aria-hidden', 'false');
        const previousOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';

        const refs = new Map();

        fields.forEach((field) => {
          const wrapper = document.createElement('label');
          wrapper.className = 'modal-field';
          const span = document.createElement('span');
          span.textContent = field.label || field.name || '';
          wrapper.appendChild(span);

          let input;
          if (field.type === 'textarea') {
            input = document.createElement('textarea');
            if (field.rows) {
              input.rows = field.rows;
            }
          } else if (field.type === 'select') {
            input = document.createElement('select');
            const options = field.options || [];
            if (field.placeholder) {
              const opt = document.createElement('option');
              opt.value = '';
              opt.textContent = field.placeholder;
              opt.disabled = true;
              opt.selected = true;
              input.appendChild(opt);
            }
            options.forEach((opt) => {
              const optionEl = document.createElement('option');
              optionEl.value = opt.value;
              optionEl.textContent = opt.label ?? opt.value;
              input.appendChild(optionEl);
            });
          } else {
            input = document.createElement('input');
            input.type = field.type || 'text';
            if (field.step !== undefined) {
              input.step = field.step;
            }
            if (field.min !== undefined) {
              input.min = field.min;
            }
            if (field.max !== undefined) {
              input.max = field.max;
            }
          }

          if (field.placeholder && field.type !== 'select') {
            input.placeholder = field.placeholder;
          }
          if (field.value !== undefined && field.value !== null) {
            input.value = field.value;
          }
          input.dataset.field = field.name || '';
          wrapper.appendChild(input);

          const hint = document.createElement('div');
          hint.className = 'error-hint';
          wrapper.appendChild(hint);

          const clearError = () => {
            input.classList.remove('input-error');
            hint.textContent = '';
          };
          input.addEventListener(field.type === 'select' ? 'change' : 'input', clearError);

          refs.set(field.name, {input, hint, field, clearError});
          modalBodyEl.appendChild(wrapper);
        });

        const firstInput = modalBodyEl.querySelector('input, textarea, select');
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 30);
        }

        function cleanup() {
          modalOverlay.classList.remove('show');
          modalOverlay.setAttribute('aria-hidden', 'true');
          modalBodyEl.innerHTML = '';
          document.body.style.overflow = previousOverflow;
          modalConfirmBtn.removeEventListener('click', handleConfirm);
          modalCancelBtn.removeEventListener('click', handleCancel);
          modalCloseBtn.removeEventListener('click', handleCancel);
          modalOverlay.removeEventListener('click', handleOverlayClick);
          document.removeEventListener('keydown', handleKeydown);
        }

        function handleCancel() {
          cleanup();
          resolve(null);
        }

        function handleConfirm() {
          const payload = {};
          for (const [name, ref] of refs.entries()) {
            const {input, hint, field} = ref;
            const raw = input.value;
            const trimmed = typeof raw === 'string' ? raw.trim() : raw;
            const shouldTrim = field.trim ?? field.type !== 'textarea';
            let value = shouldTrim ? trimmed : raw;
            const isEmpty = typeof trimmed === 'string' ? trimmed === '' : value === '' || value === undefined || value === null;
            if (field.required && isEmpty) {
              input.classList.add('input-error');
              hint.textContent = field.requiredMessage || '必填项';
              input.focus();
              return;
            }
            if (field.parser) {
              try {
                value = field.parser(value, input);
              } catch (err) {
                input.classList.add('input-error');
                hint.textContent = err?.message || '格式错误';
                input.focus();
                return;
              }
            }
            if (field.validator) {
              try {
                const result = field.validator(value, input);
                if (!result || result.ok === false) {
                  input.classList.add('input-error');
                  hint.textContent = result?.message || '格式错误';
                  input.focus();
                  return;
                }
                if (Object.prototype.hasOwnProperty.call(result, 'value')) {
                  value = result.value;
                }
              } catch (err) {
                input.classList.add('input-error');
                hint.textContent = err?.message || '格式错误';
                input.focus();
                return;
              }
            }
            payload[name] = value;
          }
          cleanup();
          resolve(payload);
        }

        function handleOverlayClick(event) {
          if (event.target === modalOverlay) {
            handleCancel();
          }
        }

        function handleKeydown(event) {
          if (event.key === 'Escape') {
            event.preventDefault();
            handleCancel();
          }
          if (event.key === 'Enter' && !event.shiftKey) {
            const active = document.activeElement;
            if (active && modalOverlay.contains(active) && active.tagName !== 'TEXTAREA') {
              event.preventDefault();
              handleConfirm();
            }
          }
        }

        modalConfirmBtn.addEventListener('click', handleConfirm);
        modalCancelBtn.addEventListener('click', handleCancel);
        modalCloseBtn.addEventListener('click', handleCancel);
        modalOverlay.addEventListener('click', handleOverlayClick);
        document.addEventListener('keydown', handleKeydown);
      });
    }

    function populateOperatorSelect(select, currentValue) {
      if (!select) return RULE_OPERATORS[0];
      const value = currentValue && currentValue !== '__custom' ? currentValue : '';
      select.innerHTML = '';
      RULE_OPERATORS.forEach((op) => {
        const option = document.createElement('option');
        option.value = op;
        option.textContent = op;
        select.appendChild(option);
      });
      if (value && !RULE_OPERATORS.includes(value)) {
        const customOption = document.createElement('option');
        customOption.value = value;
        customOption.textContent = `${value} (自定义)`;
        select.appendChild(customOption);
      }
      const triggerOption = document.createElement('option');
      triggerOption.value = '__custom';
      triggerOption.textContent = '自定义...';
      select.appendChild(triggerOption);
      const applied = value && value !== '__custom' ? value : RULE_OPERATORS[0];
      select.value = applied;
      return applied;
    }

    async function promptCustomOperator(initial = '') {
      const result = await openFormModal({
        title: '自定义操作符',
        fields: [
          {name: 'operator', label: '操作符', value: initial, required: true}
        ]
      });
      return result ? result.operator : null;
    }


    const toLower = (value) => (value ?? '').toString().toLowerCase();
    const matchesTerm = (term, ...values) => {
      if (!term) return true;
      return values.some((val) => toLower(val).includes(term));
    };
    const maybeNumber = (value) => {
      if (value === null || value === undefined || value === '') return value;
      const num = Number(value);
      return Number.isFinite(num) ? num : value;
    };

    function normalizeHost(value) {
      if (!value) return '';
      const trimmed = value.trim();
      if (!trimmed) return '';
      return trimmed.replace(/\/+$/, '');
    }

    function getApiOrigin() {
      return normalizeHost(hostInput ? hostInput.value : '');
    }

    function buildUrl(path) {
      if (!path) {
        return getApiOrigin();
      }
      if (/^https?:\/\//i.test(path)) {
        return path;
      }
      const origin = getApiOrigin();
      if (!origin) {
        return path;
      }
      if (path.startsWith('/')) {
        return `${origin}${path}`;
      }
      return `${origin}/${path}`;
    }

    function persistHost(value) {
      try {
        if (value) {
          localStorage.setItem(HOST_STORAGE_KEY, value);
        } else {
          localStorage.removeItem(HOST_STORAGE_KEY);
        }
      } catch (err) {
        console.warn('无法保存 API 地址到本地存储', err);
      }
    }

    function applyHostFromStorage() {
      if (!hostInput) return;
      try {
        const saved = localStorage.getItem(HOST_STORAGE_KEY);
        if (saved) {
          hostInput.value = saved;
          lastHostValue = normalizeHost(saved);
        }
      } catch (err) {
        console.warn('无法读取本地存储中的 API 地址', err);
      }
    }

    function reloadFromHostChange() {
      overrideListResults = [];
      overrideListMeta = {};
      overrideListError = '';
      overrideListInitialized = false;
      overrideStatsData = null;
      overrideStatsError = '';
      overrideStatsLoading = false;
      overrideLookupData = null;
      overrideLookupError = '';
      overrideLookupLoading = false;
      overrideTotalCount = 0;
      renderOverrides();
      loadConfig();
      loadVersions();
      refreshOverrideStats(true).catch((err) => console.error(err));
      queryOverrideList({}, true).catch((err) => console.error(err));
    }

    if (hostInput) {
      applyHostFromStorage();
      const syncHost = () => {
        const normalized = normalizeHost(hostInput.value);
        hostInput.value = normalized;
        if (normalized === lastHostValue) {
          return;
        }
        lastHostValue = normalized;
        persistHost(normalized);
        showStatus('API 地址已更新', normalized || '已切换为当前页面域名');
        reloadFromHostChange();
      };
      hostInput.addEventListener('change', syncHost);
      hostInput.addEventListener('blur', syncHost);
    }

    function attachSearch(selector, key, ...renderers) {
      const input = qs(selector);
      if (!input) return;
      const update = () => {
        searchFilters[key] = toLower(input.value.trim());
        renderers.forEach((fn) => fn());
      };
      input.addEventListener('input', update);
      update();
    }

    function extractUiLevel3() {
      if (!configData) return;
      configData.weights = configData.weights || {};
      configData.weights.level3 = configData.weights.level3 || {};
      const metaGroups = configData?.meta?.ui_level3_groups;
      const currentLevel3 = configData.weights.level3 || {};
      const level3Keys = Object.keys(currentLevel3);
      const level2Parents = configData.weights.level2 || {};
      const looksFlattened = level3Keys.length > 0 && level3Keys.every((key) => level2Parents[key]);

      if (metaGroups && typeof metaGroups === 'object' && (!level3Keys.length || looksFlattened)) {
        const restored = {};
        Object.entries(metaGroups).forEach(([group, metrics]) => {
          restored[group] = {...metrics};
        });
        configData.weights.level3 = restored;
      }

      if (configData.meta && Object.prototype.hasOwnProperty.call(configData.meta, 'ui_level3_groups')) {
        delete configData.meta.ui_level3_groups;
      }
    }

    function buildServerPayload() {
      const payload = JSON.parse(JSON.stringify(configData || {}));
      payload.weights = payload.weights || {};
      payload.weights.level3 = JSON.parse(JSON.stringify(configData?.weights?.level3 || {}));
      if (payload.meta && Object.prototype.hasOwnProperty.call(payload.meta, 'ui_level3_groups')) {
        delete payload.meta.ui_level3_groups;
      }
      return payload;
    }

    function getLevel1Parents() {
      return Object.keys(configData?.weights?.level2 || {});
    }

    function findLevel2Parent(groupKey) {
      const level2 = configData?.weights?.level2 || {};
      for (const [parent, entries] of Object.entries(level2)) {
        if (entries && Object.prototype.hasOwnProperty.call(entries, groupKey)) {
          return {parent, weight: entries[groupKey]};
        }
      }
      return {parent: null, weight: 0};
    }

    function moveLevel3Group(groupKey, newParent, weightValue = 0) {
      if (!configData?.weights) return;
      configData.weights.level2 = configData.weights.level2 || {};
      const level2 = configData.weights.level2;
      const numericWeight = Number(weightValue);
      const finalWeight = isFinite(numericWeight) ? numericWeight : 0;
      for (const [parent, entries] of Object.entries(level2)) {
        if (entries && Object.prototype.hasOwnProperty.call(entries, groupKey)) {
          if (parent === newParent) {
            entries[groupKey] = finalWeight;
            return parent;
          }
          delete entries[groupKey];
          break;
        }
      }
      level2[newParent] = level2[newParent] || {};
      level2[newParent][groupKey] = finalWeight;
      return newParent;
    }

    function renameLevel3GroupKey(oldKey, newKey) {
      const level2 = configData?.weights?.level2 || {};
      for (const entries of Object.values(level2)) {
        if (entries && Object.prototype.hasOwnProperty.call(entries, oldKey)) {
          const numericWeight = Number(entries[oldKey]);
          entries[newKey] = isFinite(numericWeight) ? numericWeight : 0;
          delete entries[oldKey];
          return;
        }
      }
    }

    function showStatus(title, message, timeout = 2800) {
      const bar = qs('#statusBar');
      qs('#statusTitle').textContent = title;
      qs('#statusMessage').textContent = message;
      bar.classList.add('show');
      if (timeout) {
        setTimeout(() => bar.classList.remove('show'), timeout);
      }
    }

    function fetchJSON(path, options) {
      const url = buildUrl(path);
      return fetch(url, options).then(async (res) => {
        const text = await res.text();
        let data = {};
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (err) {
            console.warn('响应不是 JSON，返回原始文本', err);
            data = {raw: text};
          }
        }
        if (!res.ok) {
          throw new Error(data.error || data.message || text || '请求失败');
        }
        return data;
      });
    }

    async function loadConfig() {
      try {
        configData = await fetchJSON(API_PATHS.config);
        extractUiLevel3();
        renderAll();
        showStatus('加载完成', '配置已同步');
      } catch (err) {
        console.error(err);
        showStatus('错误', err.message, 4500);
      }
    }

    function renderAll() {
      if (!configData) return;
      renderOverview();
      renderLevel3();
      renderCPT();
      renderRules();
      renderOverrides();
      renderWeights();
      renderCalibration();
      renderMeta();
    }

    function renderOverview() {
      if (!configData) return;
      const summary = qs('#overviewSummary');
      summary.innerHTML = '';
      const items = [
        ['版本', configData.version],
        ['更新时间', configData.updated_at],
        ['规则数量', configData.rules?.length ?? 0],
        ['阈值数量', configData.thresholds?.length ?? 0],
        ['CPT 项目', Object.keys(configData.cpt || {}).length],
        ['三级指标组', Object.keys(configData.weights?.level3 || {}).length]
      ];
      const term = searchFilters.overview;
      const filtered = term ? items.filter(([label, value]) => matchesTerm(term, label, value)) : items;
      if (!filtered.length) {
        summary.innerHTML = '<div class="small">未找到匹配的概览信息</div>';
      } else {
        for (const [label, value] of filtered) {
          const row = document.createElement('div');
          row.innerHTML = `<span class="chip">${label}</span><div style="font-size:1rem;font-weight:600">${value ?? '—'}</div>`;
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.justifyContent = 'space-between';
          summary.appendChild(row);
        }
      }
      renderVersionList();
    }

    async function loadVersions() {
      try {
        versionCache = await fetchJSON(API_PATHS.versions);
        renderVersionList();
      } catch (err) {
        showStatus('错误', err.message, 4000);
        versionCache = [];
        renderVersionList();
      }
    }

    function renderVersionList() {
      const box = qs('#versionList');
      if (!box) return;
      box.innerHTML = '';
      if (!versionCache.length) {
        box.innerHTML = '<div class="small">暂无快照</div>';
        return;
      }
      const term = searchFilters.overview;
      const filtered = term
        ? versionCache.filter((v) => matchesTerm(term, v.name, v.modified, v.size))
        : versionCache;
      if (!filtered.length) {
        box.innerHTML = '<div class="small">未找到匹配的版本快照</div>';
        return;
      }
      filtered.forEach((v) => {
        const item = document.createElement('div');
        item.className = 'card';
        item.style.padding = '0.75rem';
        item.style.gap = '0.35rem';
        item.innerHTML = `
          <div style="font-weight:600">${v.name}</div>
          <div class="small">${new Date(v.modified).toLocaleString()}</div>
          <div class="small">${(v.size / 1024).toFixed(2)} KB</div>
          <button class="muted-btn" style="padding:0.35rem 0.8rem">恢复此版本</button>
        `;
        item.querySelector('button').addEventListener('click', async () => {
          if (!confirm('确认恢复该版本? 当前配置将被覆盖。')) return;
          try {
            await fetchJSON(API_PATHS.restore, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({name: v.name})
            });
            showStatus('恢复完成', `已恢复版本 ${v.name}`);
            loadConfig();
          } catch (err) {
            showStatus('错误', err.message, 4000);
          }
        });
        box.appendChild(item);
      });
    }

    function renderLevel3() {
      if (!configData) return;
      const container = qs('#level3Container');
      container.innerHTML = '';
      configData.weights = configData.weights || {};
      configData.weights.level2 = configData.weights.level2 || {};
      configData.weights.level3 = configData.weights.level3 || {};
      const level3 = configData.weights.level3;
      const level3Keys = new Set(Object.keys(level3));
      Object.values(configData.weights.level2).forEach((entries) => {
        if (!entries) return;
        Object.keys(entries).forEach((child) => {
          if (!level3Keys.has(child)) {
            delete entries[child];
          }
        });
      });
      const template = qs('#level3GroupTemplate');
      const metricTemplate = qs('#metricRowTemplate');

      const term = searchFilters.level3;
      const entries = Object.entries(level3).filter(([groupKey, metrics]) => {
        if (!term) return true;
        if (matchesTerm(term, groupKey)) return true;
        return Object.entries(metrics || {}).some(([metricKey, metricVal]) => matchesTerm(term, metricKey, metricVal));
      });

      if (!entries.length) {
        container.innerHTML = '<div class="small">未找到匹配的指标组</div>';
        return;
      }

      entries.forEach(([groupKey, metrics]) => {
        const node = template.content.firstElementChild.cloneNode(true);
        const nameInput = node.querySelector('.group-name');
        nameInput.value = groupKey;
        nameInput.dataset.original = groupKey;

        const parentSelect = node.querySelector('.group-parent');
        const weightInput = node.querySelector('.parent-weight');
        const parents = getLevel1Parents();
        const parentInfo = findLevel2Parent(groupKey);
        let currentParent = parentInfo.parent;
        let currentWeight = Number(parentInfo.weight ?? 0);
        if (!isFinite(currentWeight)) currentWeight = 0;

        parentSelect.innerHTML = '';
        if (!parents.length) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '未配置一级分类';
          parentSelect.appendChild(opt);
          parentSelect.disabled = true;
          weightInput.disabled = true;
        } else {
          parents.forEach((parent) => {
            const opt = document.createElement('option');
            opt.value = parent;
            opt.textContent = parent;
            if (parent === currentParent) opt.selected = true;
            parentSelect.appendChild(opt);
          });

          if (!currentParent) {
            currentParent = parents[0];
            moveLevel3Group(groupKey, currentParent, currentWeight);
            parentSelect.value = currentParent;
          }

          parentSelect.disabled = false;
          weightInput.disabled = false;
        }

        weightInput.value = currentWeight;

        parentSelect.addEventListener('change', () => {
          const newParent = parentSelect.value;
          const weightVal = parseFloat(weightInput.value);
          const finalWeight = isFinite(weightVal) ? weightVal : 0;
          currentParent = moveLevel3Group(groupKey, newParent, finalWeight) || newParent;
          currentWeight = finalWeight;
          renderWeights();
          showStatus('已更新', `${groupKey} 归属调整到 ${newParent}`);
        });

        weightInput.addEventListener('input', () => {
          const weightVal = parseFloat(weightInput.value);
          if (!isFinite(weightVal)) return;
          currentWeight = weightVal;
          if (currentParent) {
            moveLevel3Group(groupKey, currentParent, currentWeight);
            renderWeights();
          }
        });

        weightInput.addEventListener('blur', () => {
          const weightVal = parseFloat(weightInput.value);
          if (isFinite(weightVal)) return;
          currentWeight = 0;
          weightInput.value = 0;
          if (currentParent) {
            moveLevel3Group(groupKey, currentParent, currentWeight);
            renderWeights();
          }
        });

        node.querySelector('.rename-group').addEventListener('click', () => {
          const newName = nameInput.value.trim();
          const orig = nameInput.dataset.original;
          if (!newName || newName === orig) return;
          if (configData.weights.level3[newName]) {
            showStatus('重命名失败', '存在同名指标组');
            nameInput.value = orig;
            return;
          }
          const metricsCopy = configData.weights.level3[orig];
          renameLevel3GroupKey(orig, newName);
          configData.weights.level3[newName] = metricsCopy;
          delete configData.weights.level3[orig];
          renderLevel3();
          renderWeights();
          showStatus('已更新', `组 ${orig} -> ${newName}`);
        });

        node.querySelector('.delete-group').addEventListener('click', () => {
          if (!confirm(`删除指标组 ${groupKey}?`)) return;
          const parentInfo = findLevel2Parent(groupKey);
          if (parentInfo.parent && configData.weights?.level2?.[parentInfo.parent]) {
            delete configData.weights.level2[parentInfo.parent][groupKey];
          }
          delete configData.weights.level3[groupKey];
          renderLevel3();
          renderWeights();
          showStatus('已删除', `指标组 ${groupKey} 已移除`);
        });

        const metricBox = node.querySelector('.metrics');
        metricBox.style.display = 'grid';
        metricBox.style.gap = '0.75rem';

        Object.entries(metrics).forEach(([metricKey, metricVal]) => {
          const row = metricTemplate.content.firstElementChild.cloneNode(true);
          const nameField = row.querySelector('.metric-name');
          const valueField = row.querySelector('.metric-value');
          nameField.value = metricKey;
          valueField.value = metricVal;

          nameField.addEventListener('change', () => {
            const newKey = nameField.value.trim();
            if (!newKey) {
              nameField.value = metricKey;
              return;
            }
            if (newKey !== metricKey && metrics[newKey] !== undefined) {
              showStatus('更新失败', '同组内存在同名指标');
              nameField.value = metricKey;
              return;
            }
            if (newKey === metricKey) return;
            metrics[newKey] = metrics[metricKey];
            delete metrics[metricKey];
            renderLevel3();
          });

          valueField.addEventListener('input', () => {
            const val = parseFloat(valueField.value);
            metrics[nameField.value.trim()] = isFinite(val) ? val : 0;
          });

          row.querySelector('.delete-metric').addEventListener('click', () => {
            if (!confirm(`删除指标 ${metricKey}?`)) return;
            delete metrics[metricKey];
            renderLevel3();
          });

          metricBox.appendChild(row);
        });

        node.querySelector('.add-metric').addEventListener('click', async () => {
          const metricsObj = configData.weights.level3[groupKey];
          let idx = 1;
          let suggest = `new_metric_${idx}`;
          while (metricsObj[suggest] !== undefined) {
            idx += 1;
            suggest = `new_metric_${idx}`;
          }
          const result = await openFormModal({
            title: `新增指标 (${groupKey})`,
            fields: [
              {name: 'key', label: '指标键名', value: suggest, required: true},
              {
                name: 'weight',
                label: '权重',
                type: 'number',
                step: '0.01',
                value: '0',
                parser: (value) => {
                  if (value === '' || value === null || value === undefined) return 0;
                  const num = parseFloat(value);
                  if (!Number.isFinite(num)) {
                    throw new Error('请输入数字');
                  }
                  return num;
                }
              }
            ]
          });
          if (!result) return;
          if (metricsObj[result.key] !== undefined) {
            showStatus('新增失败', `指标 ${result.key} 已存在`);
            return;
          }
          metricsObj[result.key] = result.weight ?? 0;
          renderLevel3();
          showStatus('新增完成', `已在 ${groupKey} 添加 ${result.key}`);
        });

        container.appendChild(node);
      });
    }

    function renderCPT() {
      if (!configData) return;
      const container = qs('#cptContainer');
      container.innerHTML = '';
      const cpt = configData.cpt || {};
      const term = searchFilters.cpt;
      const entries = Object.entries(cpt).filter(([key, value]) => matchesTerm(term, key, JSON.stringify(value)));
      if (!entries.length) {
        container.innerHTML = '<div class="small">未找到匹配的 CPT 条目</div>';
        return;
      }
      entries.forEach(([key, value]) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between;align-items:center">
            <span class="chip">${key}</span>
            <div class="flex">
              <button class="muted-btn apply-json">应用修改</button>
              <button class="danger delete-json">删除</button>
            </div>
          </div>
          <textarea class="json-editor"></textarea>
        `;
        const textarea = card.querySelector('.json-editor');
        textarea.value = JSON.stringify(value, null, 2);
        card.querySelector('.apply-json').addEventListener('click', () => {
          try {
            configData.cpt[key] = JSON.parse(textarea.value);
            showStatus('已更新', `CPT: ${key}`);
          } catch (err) {
            showStatus('解析错误', err.message, 4000);
          }
        });
        card.querySelector('.delete-json').addEventListener('click', () => {
          if (!confirm(`删除 CPT 条目 ${key}?`)) return;
          delete configData.cpt[key];
          renderCPT();
        });
        container.appendChild(card);
      });
    }

    function renderRules() {
      if (!configData) return;
      const container = qs('#rulesContainer');
      container.innerHTML = '';
      const rules = configData.rules || [];
      const term = searchFilters.rules;
      let hasAny = false;
      rules.forEach((rule, idx) => {
        if (term && !matchesTerm(term, rule.name, JSON.stringify(rule.then), JSON.stringify(rule.if))) {
          return;
        }
        hasAny = true;
        const card = document.createElement('div');
        card.className = 'rule-card';
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between;align-items:center">
            <input class="rule-name" value="${rule.name || ''}" style="flex:1" />
            <button class="danger delete-rule" style="height:40px">删除</button>
          </div>
          <div>
            <div class="chip" style="margin-bottom:0.5rem">条件 IF</div>
            <div class="rule-conditions"></div>
            <button class="muted-btn add-condition" style="margin-top:0.5rem">新增条件</button>
          </div>
          <div>
            <div class="chip" style="margin-bottom:0.5rem">结果 THEN</div>
            <textarea class="rule-then"></textarea>
          </div>
        `;
        const nameInput = card.querySelector('.rule-name');
        nameInput.addEventListener('input', () => {
          configData.rules[idx].name = nameInput.value;
        });

        const thenBox = card.querySelector('.rule-then');
        thenBox.value = JSON.stringify(rule.then || {}, null, 2);
        thenBox.addEventListener('change', () => {
          try {
            configData.rules[idx].then = JSON.parse(thenBox.value);
            showStatus('已更新', `规则 ${idx + 1} THEN`);
          } catch (err) {
            showStatus('解析错误', err.message, 4000);
          }
        });

        const conditionsBox = card.querySelector('.rule-conditions');
        (rule.if || []).forEach((cond, cIdx) => {
          const row = document.createElement('div');
          row.className = 'condition-row';
          row.innerHTML = `
            <label>变量<input class="cond-var" value="${cond.var ?? ''}"></label>
            <label>操作符<select class="cond-op"></select></label>
            <label>值<textarea class="cond-value" style="min-height:60px"></textarea></label>
            <button class="danger delete-condition" style="height:40px">删除</button>
          `;
          const valueArea = row.querySelector('.cond-value');
          const serializedValue = cond.value === undefined ? '""' : JSON.stringify(cond.value, null, 2);
          valueArea.value = serializedValue ?? '""';

          row.querySelector('.cond-var').addEventListener('input', (e) => {
            configData.rules[idx].if[cIdx].var = e.target.value;
          });
          const opSelect = row.querySelector('.cond-op');
          const appliedOp = populateOperatorSelect(opSelect, cond.op);
          if (!cond.op) {
            configData.rules[idx].if[cIdx].op = appliedOp;
          }
          opSelect.addEventListener('change', async (event) => {
            let selected = event.target.value;
            if (selected === '__custom') {
              const custom = await promptCustomOperator(cond.op || '');
              if (!custom) {
                populateOperatorSelect(opSelect, cond.op);
                return;
              }
              selected = custom;
              populateOperatorSelect(opSelect, selected);
            }
            configData.rules[idx].if[cIdx].op = selected;
          });
          valueArea.addEventListener('change', () => {
            try {
              configData.rules[idx].if[cIdx].value = JSON.parse(valueArea.value);
              showStatus('已更新', `规则 ${idx + 1} 条件`);
            } catch (err) {
              showStatus('解析错误', err.message, 4000);
            }
          });
          row.querySelector('.delete-condition').addEventListener('click', () => {
            configData.rules[idx].if.splice(cIdx, 1);
            renderRules();
          });
          conditionsBox.appendChild(row);
        });

        card.querySelector('.add-condition').addEventListener('click', async () => {
          const result = await openFormModal({
            title: `新增条件 (${rule.name || `规则 ${idx + 1}`})`,
            fields: [
              {name: 'var', label: '变量', placeholder: '如 intent', required: true},
              {
                name: 'op',
                label: '操作符',
                type: 'select',
                options: [...RULE_OPERATORS.map((op) => ({value: op, label: op})), {value: '__custom', label: '自定义...'}],
                value: RULE_OPERATORS[0]
              },
              {
                name: 'value',
                label: '值 (JSON)',
                type: 'textarea',
                value: '""',
                parser: (value) => {
                  try {
                    return value ? JSON.parse(value) : '';
                  } catch (err) {
                    throw new Error(err.message || 'JSON 解析失败');
                  }
                }
              }
            ]
          });
          if (!result) return;
          let opValue = result.op;
          if (opValue === '__custom') {
            const custom = await promptCustomOperator();
            if (!custom) return;
            opValue = custom;
          }
          configData.rules[idx].if = configData.rules[idx].if || [];
          configData.rules[idx].if.push({op: opValue, var: result.var, value: result.value});
          renderRules();
          showStatus('新增完成', `规则 ${rule.name || idx + 1} 已添加条件`);
        });

        card.querySelector('.delete-rule').addEventListener('click', () => {
          if (!confirm(`删除规则 ${rule.name || idx + 1}?`)) return;
          configData.rules.splice(idx, 1);
          renderRules();
        });

        container.appendChild(card);
      });
      if (!hasAny) {
        container.innerHTML = '<div class="small">未找到匹配的规则</div>';
      }
    }

    function pushOverrideLogEntry(type, data = null, message = '', ts = null) {
      overrideLog.unshift({
        type,
        data,
        message,
        ts: ts || new Date().toISOString()
      });
      if (overrideLog.length > MAX_OVERRIDE_LOG) {
        overrideLog.length = MAX_OVERRIDE_LOG;
      }
    }

    function renderOverrides() {
      renderOverrideHistory();
      renderOverridePreview();
      renderOverrideStats();
      renderOverrideLookup();
      renderOverrideList();
    }

    function renderOverrideHistory() {
      const list = qs('#overrideHistoryList');
      if (!list) return;
      list.innerHTML = '';
      const totalLabel = qs('#overrideTotalLabel');
      if (totalLabel) {
        totalLabel.textContent = `已知标注总数：${overrideTotalCount}`;
      }
      const term = searchFilters.overrides;
      const filtered = overrideLog.filter((entry) => matchesTerm(term, entry.type, entry.message, JSON.stringify(entry.data)));
      if (!filtered.length) {
        list.innerHTML = '<div class="small">暂无匹配的标注记录</div>';
        return;
      }
      const typeNames = {
        save: '写入',
        delete: '删除',
        reset: '清空',
        batch: '批量',
        info: '通知'
      };
      filtered.forEach((entry) => {
        const card = document.createElement('div');
        card.className = 'group-card';
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between;align-items:center">
            <span class="chip">${typeNames[entry.type] || entry.type}</span>
            <span class="small">${new Date(entry.ts).toLocaleString()}</span>
          </div>
        `;
        if (entry.message) {
          const msg = document.createElement('div');
          msg.className = 'small';
          msg.textContent = entry.message;
          card.appendChild(msg);
        }
        if (entry.data) {
          const pre = document.createElement('pre');
          pre.style.margin = '0';
          pre.style.background = 'rgba(15, 23, 42, 0.55)';
          pre.style.padding = '0.75rem';
          pre.style.borderRadius = '12px';
          pre.style.fontSize = '0.8rem';
          pre.style.whiteSpace = 'pre-wrap';
          pre.textContent = JSON.stringify(entry.data, null, 2);
          card.appendChild(pre);
        }
        list.appendChild(card);
      });
    }

    function renderOverridePreview() {
      const box = qs('#overridePreviewOutput');
      if (!box) return;
      box.innerHTML = '';
      if (!overridePreviewData.length) {
        box.innerHTML = '<div class="small">粘贴 /calculate 返回的结果并点击“解析结果”。</div>';
        return;
      }
      const term = searchFilters.overrides;
      let hasAny = false;
      overridePreviewData.forEach((item, idx) => {
        const finalLevel = item.has_override && item.override?.threat_level ? item.override.threat_level : item.threat_level;
        const baseLevel = item.threat_level ?? '—';
        const identifier = item.mbPh ?? item.mbnm ?? item.override?.mbPh ?? item.override?.mbnm ?? `#${idx + 1}`;
        const reason = item.override?.reason ?? '';
        const actor = item.override?.by ?? '';
        if (term && !matchesTerm(term, identifier, finalLevel, baseLevel, reason, actor)) {
          return;
        }
        hasAny = true;
        const card = document.createElement('div');
        card.className = 'group-card';
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between;align-items:center">
            <span class="chip">${identifier}</span>
            <span class="small">${item.has_override ? '已覆盖' : '计算结果'}</span>
          </div>
          <div class="flex" style="justify-content:space-between;align-items:center">
            <div>最终威胁等级：<strong>${finalLevel ?? '—'}</strong></div>
            <div class="small">原始：${baseLevel ?? '—'}</div>
          </div>
        `;
        if (item.has_override && item.override) {
          const info = document.createElement('div');
          info.className = 'small';
          info.textContent = `覆盖人: ${actor || '—'} · 理由: ${reason || '未提供'}`;
          card.appendChild(info);
        }
        box.appendChild(card);
      });
      if (!hasAny) {
        box.innerHTML = '<div class="small">未找到匹配的威胁结果</div>';
      }
    }

    function renderOverrideStats() {
      const box = qs('#overrideStatsBox');
      if (!box) return;
      box.innerHTML = '';
      if (overrideStatsLoading) {
        box.innerHTML = '<div class="small">统计加载中...</div>';
        return;
      }
      if (overrideStatsError) {
        box.innerHTML = `<div class="small">${overrideStatsError}</div>`;
        return;
      }
      if (!overrideStatsData) {
        box.innerHTML = '<div class="small">点击“刷新统计”获取最新数据。</div>';
        return;
      }
      const entries = Object.entries(overrideStatsData);
      if (!entries.length) {
        box.innerHTML = '<div class="small">暂无统计数据</div>';
        return;
      }
      entries.forEach(([key, value]) => {
        const wrap = document.createElement('div');
        wrap.style.display = 'grid';
        wrap.style.gap = '0.35rem';
        const label = document.createElement('div');
        label.className = 'chip';
        label.textContent = key;
        wrap.appendChild(label);
        if (value && typeof value === 'object') {
          const pre = document.createElement('pre');
          pre.style.margin = '0';
          pre.style.background = 'rgba(15, 23, 42, 0.55)';
          pre.style.padding = '0.6rem 0.75rem';
          pre.style.borderRadius = '10px';
          pre.style.whiteSpace = 'pre-wrap';
          pre.style.fontSize = '0.8rem';
          pre.textContent = JSON.stringify(value, null, 2);
          wrap.appendChild(pre);
        } else {
          const text = document.createElement('div');
          text.style.fontWeight = '600';
          text.textContent = value ?? '—';
          wrap.appendChild(text);
        }
        box.appendChild(wrap);
      });
    }

    function renderOverrideLookup() {
      const box = qs('#overrideLookupResult');
      if (!box) return;
      box.innerHTML = '';
      if (overrideLookupLoading) {
        box.innerHTML = '<div class="small">查询中...</div>';
        return;
      }
      if (overrideLookupError) {
        box.innerHTML = `<div class="small">${overrideLookupError}</div>`;
        return;
      }
      if (!overrideLookupData) {
        box.innerHTML = '<div class="small">提交查询以查看单条标注详情。</div>';
        return;
      }
      const card = document.createElement('div');
      card.className = 'group-card';
      const identifier = overrideLookupData.mbPh ?? overrideLookupData.mbnm ?? overrideLookupData.id ?? '标注';
      const level = overrideLookupData.threat_level ?? overrideLookupData.level ?? '—';
      const actor = overrideLookupData.by ?? overrideLookupData.operator ?? '—';
      const reason = overrideLookupData.reason ?? '';
      const ts = overrideLookupData.ts ?? overrideLookupData.updated_at ?? overrideLookupData.created_at;
      card.innerHTML = `
        <div class="flex" style="justify-content:space-between;align-items:center">
          <span class="chip">${identifier}</span>
          <span class="small">等级 ${level}</span>
        </div>
      `;
      const meta = document.createElement('div');
      meta.className = 'small';
      meta.textContent = `操作员: ${actor}${ts ? ` · 时间: ${new Date(ts).toLocaleString()}` : ''}`;
      card.appendChild(meta);
      if (reason) {
        const reasonEl = document.createElement('div');
        reasonEl.className = 'small';
        reasonEl.textContent = `理由: ${reason}`;
        card.appendChild(reasonEl);
      }
      const ids = [];
      if (overrideLookupData.mbPh !== undefined) ids.push(`mbPh: ${overrideLookupData.mbPh}`);
      if (overrideLookupData.mbnm) ids.push(`mbnm: ${overrideLookupData.mbnm}`);
      if (ids.length) {
        const idRow = document.createElement('div');
        idRow.className = 'small';
        idRow.textContent = ids.join(' · ');
        card.appendChild(idRow);
      }
      const pre = document.createElement('pre');
      pre.style.margin = '0';
      pre.style.background = 'rgba(15, 23, 42, 0.55)';
      pre.style.padding = '0.6rem 0.75rem';
      pre.style.borderRadius = '10px';
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.fontSize = '0.8rem';
      pre.textContent = JSON.stringify(overrideLookupData, null, 2);
      card.appendChild(pre);
      box.appendChild(card);
    }

    function syncOverrideQueryForm() {
      const levelInput = qs('#overrideQueryLevel');
      const byInput = qs('#overrideQueryBy');
      const termInput = qs('#overrideQueryTerm');
      const limitInput = qs('#overrideQueryLimit');
      const offsetInput = qs('#overrideQueryOffset');
      if (levelInput) levelInput.value = overrideQueryParams.level ?? '';
      if (byInput) byInput.value = overrideQueryParams.by ?? '';
      if (termInput) termInput.value = overrideQueryParams.q ?? '';
      if (limitInput) limitInput.value = overrideQueryParams.limit ?? '';
      if (offsetInput) offsetInput.value = overrideQueryParams.offset ?? '';
    }

    function renderOverrideList() {
      const box = qs('#overrideQueryResults');
      const meta = qs('#overrideQueryMeta');
      syncOverrideQueryForm();
      if (meta) {
        const metaParts = [];
        if (typeof overrideListMeta.total === 'number') metaParts.push(`总数 ${overrideListMeta.total}`);
        if (typeof overrideListMeta.offset === 'number') metaParts.push(`偏移 ${overrideListMeta.offset}`);
        if (typeof overrideListMeta.limit === 'number') metaParts.push(`每页 ${overrideListMeta.limit}`);
        meta.textContent = metaParts.join(' · ');
      }
      if (!box) return;
      box.innerHTML = '';
      if (overrideListLoading) {
        box.innerHTML = '<div class="small">查询中...</div>';
        return;
      }
      if (overrideListError) {
        box.innerHTML = `<div class="small">${overrideListError}</div>`;
        return;
      }
      const term = searchFilters.overrides;
      const filtered = term
        ? overrideListResults.filter((item) => matchesTerm(term, item.mbPh, item.mbnm, item.by, item.reason, item.threat_level, JSON.stringify(item)))
        : overrideListResults;
      if (!filtered.length) {
        box.innerHTML = '<div class="small">暂无标注数据</div>';
        return;
      }
      filtered.forEach((item) => {
        const identifier = item.mbPh ?? item.mbnm ?? item.id ?? '标注';
        const level = item.threat_level ?? item.level ?? '—';
        const actor = item.by ?? item.operator ?? '—';
        const reason = item.reason ?? '';
        const ts = item.ts ?? item.updated_at ?? item.created_at;
        const card = document.createElement('div');
        card.className = 'group-card';
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between;align-items:center">
            <span class="chip">${identifier}</span>
            <span class="small">等级 ${level}</span>
          </div>
        `;
        const metaLine = document.createElement('div');
        metaLine.className = 'small';
        metaLine.textContent = `操作员: ${actor}${ts ? ` · 时间: ${new Date(ts).toLocaleString()}` : ''}`;
        card.appendChild(metaLine);
        if (reason) {
          const reasonEl = document.createElement('div');
          reasonEl.className = 'small';
          reasonEl.textContent = `理由: ${reason}`;
          card.appendChild(reasonEl);
        }
        const ids = [];
        if (item.mbPh !== undefined) ids.push(`mbPh: ${item.mbPh}`);
        if (item.mbnm) ids.push(`mbnm: ${item.mbnm}`);
        if (ids.length) {
          const idRow = document.createElement('div');
          idRow.className = 'small';
          idRow.textContent = ids.join(' · ');
          card.appendChild(idRow);
        }
        const pre = document.createElement('pre');
        pre.style.margin = '0';
        pre.style.background = 'rgba(15, 23, 42, 0.55)';
        pre.style.padding = '0.6rem 0.75rem';
        pre.style.borderRadius = '10px';
        pre.style.whiteSpace = 'pre-wrap';
        pre.style.fontSize = '0.8rem';
        pre.textContent = JSON.stringify(item, null, 2);
        card.appendChild(pre);
        box.appendChild(card);
      });
    }

    async function refreshOverrideStats(silent = false) {
      overrideStatsLoading = true;
      overrideStatsError = '';
      renderOverrideStats();
      try {
        const data = await fetchJSON(API_PATHS.overrideStats);
        overrideStatsData = data;
        overrideStatsLoading = false;
        if (typeof data.total_overrides === 'number') {
          overrideTotalCount = data.total_overrides;
        } else if (typeof data.total === 'number') {
          overrideTotalCount = data.total;
        }
        renderOverrideStats();
        renderOverrideHistory();
        if (!silent) {
          showStatus('统计已更新', '威胁标注统计获取成功');
        }
        return data;
      } catch (err) {
        overrideStatsLoading = false;
        overrideStatsData = null;
        overrideStatsError = err.message;
        renderOverrideStats();
        if (!silent) {
          showStatus('统计获取失败', err.message, 4500);
        }
        throw err;
      }
    }

    async function lookupOverrideItem(type, value) {
      overrideLookupLoading = true;
      overrideLookupError = '';
      overrideLookupData = null;
      renderOverrideLookup();
      try {
        const path = `${API_PATHS.overrides}/${encodeURIComponent(type)}/${encodeURIComponent(value)}`;
        const data = await fetchJSON(path);
        overrideLookupLoading = false;
        overrideLookupData = data;
        renderOverrideLookup();
        showStatus('查询成功', `${type} ${value} 的标注已获取`);
        return data;
      } catch (err) {
        overrideLookupLoading = false;
        overrideLookupError = err.message;
        overrideLookupData = null;
        renderOverrideLookup();
        showStatus('查询失败', err.message, 4500);
        throw err;
      }
    }

    async function queryOverrideList(params = {}, silent = false) {
      overrideListLoading = true;
      overrideListError = '';
      overrideListResults = [];
      renderOverrideList();
      const nextParams = {...overrideQueryParams, ...params};
      overrideQueryParams = nextParams;
      const search = new URLSearchParams();
      if (nextParams.level) search.set('level', nextParams.level);
      if (nextParams.by) search.set('by', nextParams.by);
      if (nextParams.q) search.set('q', nextParams.q);
      if (nextParams.limit) search.set('limit', nextParams.limit);
      if (typeof nextParams.offset === 'number' || nextParams.offset) search.set('offset', nextParams.offset);
      const qsStr = search.toString();
      const path = qsStr ? `${API_PATHS.overrides}?${qsStr}` : API_PATHS.overrides;
      try {
        const data = await fetchJSON(path);
        const items = Array.isArray(data)
          ? data
          : Array.isArray(data.items)
            ? data.items
            : Array.isArray(data.data)
              ? data.data
              : Array.isArray(data.results)
                ? data.results
                : [];
        overrideListResults = items;
        overrideQueryParams = {
          level: nextParams.level || '',
          by: nextParams.by || '',
          q: nextParams.q || '',
          limit: nextParams.limit === '' ? '' : (Number.isFinite(Number(nextParams.limit)) ? Number(nextParams.limit) : nextParams.limit),
          offset: nextParams.offset === '' ? '' : (Number.isFinite(Number(nextParams.offset)) ? Number(nextParams.offset) : nextParams.offset)
        };
        const totalValue = data.total ?? data.total_overrides ?? data.count ?? items.length;
        const limitValue = data.limit ?? nextParams.limit ?? items.length;
        const offsetValue = data.offset ?? nextParams.offset ?? 0;
        if (Number.isFinite(Number(totalValue))) {
          overrideTotalCount = Number(totalValue);
        }
        overrideListMeta = {
          total: Number.isFinite(Number(totalValue)) ? Number(totalValue) : totalValue,
          limit: Number.isFinite(Number(limitValue)) ? Number(limitValue) : limitValue,
          offset: Number.isFinite(Number(offsetValue)) ? Number(offsetValue) : offsetValue
        };
        renderOverrideHistory();
        overrideListInitialized = true;
        overrideListLoading = false;
        renderOverrideList();
        if (!silent) {
          showStatus('查询完成', `共返回 ${items.length} 条标注`);
        }
        return data;
      } catch (err) {
        overrideListLoading = false;
        overrideListResults = [];
        overrideListMeta = {};
        overrideListError = err.message;
        renderOverrideList();
        if (!silent) {
          showStatus('查询失败', err.message, 4500);
        }
        throw err;
      }
    }

    async function sendOverrideRequest(payload, successMessage, logType = 'info') {
      try {
        const resp = await fetchJSON(API_PATHS.calculate, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        let hadSaved = false;
        if (Array.isArray(resp.saved) && resp.saved.length) {
          hadSaved = true;
          resp.saved.forEach((item) => {
            pushOverrideLogEntry('save', item, `标注等级 ${item.threat_level ?? ''}`, item.ts);
          });
        }
        if (!hadSaved) {
          pushOverrideLogEntry(logType, payload.override || payload, successMessage);
        }
        if (typeof resp.total_overrides === 'number') {
          overrideTotalCount = resp.total_overrides;
        }
        renderOverrides();
        refreshOverrideStats(true).catch((err) => console.error(err));
        if (overrideListInitialized) {
          queryOverrideList({}, true).catch((err) => console.error(err));
        }
        showStatus('操作成功', successMessage || '请求已完成');
        return resp;
      } catch (err) {
        showStatus('操作失败', err.message, 4500);
        throw err;
      }
    }

    function renderWeights() {
      if (!configData) return;
      const level1Box = qs('#level1Weights');
      const level2Box = qs('#level2Weights');
      level1Box.innerHTML = '';
      level2Box.innerHTML = '';

      const level1 = configData.weights?.level1 || {};
      const term = searchFilters.weights;
      const level1Entries = Object.entries(level1).filter(([key, val]) => matchesTerm(term, key, val));
      if (!level1Entries.length) {
        level1Box.innerHTML = '<div class="small">未找到匹配的 Level1 权重</div>';
      }
      level1Entries.forEach(([key, val]) => {
        const row = document.createElement('div');
        row.className = 'flex';
        row.style.alignItems = 'center';
        row.innerHTML = `
          <label style="flex:1">
            ${key}
            <input type="number" step="0.01" value="${val}" />
          </label>
        `;
        row.querySelector('input').addEventListener('input', (e) => {
          configData.weights.level1[key] = parseFloat(e.target.value) || 0;
        });
        level1Box.appendChild(row);
      });

      const level2 = configData.weights?.level2 || {};
      const level2Entries = Object.entries(level2).filter(([groupKey, entries]) => {
        if (!term) return true;
        if (matchesTerm(term, groupKey)) return true;
        return Object.entries(entries || {}).some(([key, val]) => matchesTerm(term, key, val));
      });
      if (!level2Entries.length) {
        level2Box.innerHTML = '<div class="small">未找到匹配的 Level2 权重</div>';
        return;
      }
      level2Entries.forEach(([groupKey, entries]) => {
        const card = document.createElement('div');
        card.className = 'group-card';
        card.innerHTML = `
          <div class="chip">${groupKey}</div>
          <div class="grid" style="gap:0.5rem"></div>
        `;
        const grid = card.querySelector('.grid');
        Object.entries(entries).forEach(([key, val]) => {
          const row = document.createElement('div');
          row.innerHTML = `
            <label>${key}<input type="number" step="0.01" value="${val}" /></label>
          `;
          row.querySelector('input').addEventListener('input', (e) => {
            configData.weights.level2[groupKey][key] = parseFloat(e.target.value) || 0;
          });
          grid.appendChild(row);
        });
        level2Box.appendChild(card);
      });
    }

    function renderCalibration() {
      if (!configData) return;
      const caliBox = qs('#calibrationContainer');
      const thresholdsBox = qs('#thresholdsContainer');
      caliBox.innerHTML = '';
      thresholdsBox.innerHTML = '';

      const calibration = configData.calibration || {};
      const term = searchFilters.calibration;
      const calEntries = Object.entries(calibration).filter(([key, value]) => matchesTerm(term, key, JSON.stringify(value)));
      if (!calEntries.length) {
        caliBox.innerHTML = '<div class="small">未找到匹配的校准项</div>';
      }
      calEntries.forEach(([key, value]) => {
        const card = document.createElement('div');
        card.className = 'group-card';
        card.innerHTML = `
          <div class="flex" style="justify-content:space-between;align-items:center">
            <span class="chip">${key}</span>
            <button class="muted-btn apply-json">应用修改</button>
          </div>
          <textarea class="json-editor"></textarea>
        `;
        const textarea = card.querySelector('.json-editor');
        textarea.value = JSON.stringify(value, null, 2);
        card.querySelector('.apply-json').addEventListener('click', () => {
          try {
            calibration[key] = JSON.parse(textarea.value);
            showStatus('已更新', `校准 ${key}`);
          } catch (err) {
            showStatus('解析错误', err.message, 4000);
          }
        });
        caliBox.appendChild(card);
      });

      const thresholds = configData.thresholds || [];
      let hasThreshold = false;
      thresholds.forEach((item, idx) => {
        if (term && !matchesTerm(term, item.label, item.level, item.min)) {
          return;
        }
        hasThreshold = true;
        const row = document.createElement('div');
        row.className = 'card';
        row.innerHTML = `
          <div class="flex" style="gap:0.75rem">
            <label style="flex:1">标签<input value="${item.label || ''}" class="th-label" /></label>
            <label style="width:120px">等级<input value="${item.level || ''}" class="th-level" /></label>
            <label style="width:140px">最小值<input type="number" step="0.01" value="${item.min ?? ''}" class="th-min" /></label>
            <button class="danger delete-th" style="height:40px">删除</button>
          </div>
        `;
        row.querySelector('.th-label').addEventListener('input', (e) => {
          configData.thresholds[idx].label = e.target.value;
        });
        row.querySelector('.th-level').addEventListener('input', (e) => {
          configData.thresholds[idx].level = e.target.value;
        });
        row.querySelector('.th-min').addEventListener('input', (e) => {
          configData.thresholds[idx].min = parseFloat(e.target.value) || 0;
        });
        row.querySelector('.delete-th').addEventListener('click', () => {
          configData.thresholds.splice(idx, 1);
          renderCalibration();
        });
        thresholdsBox.appendChild(row);
      });
      if (!hasThreshold) {
        thresholdsBox.innerHTML = '<div class="small">未找到匹配的阈值</div>';
      }
    }

    function renderMeta() {
      if (!configData) return;
      const term = searchFilters.meta;
      const notesInput = qs('#metaNotes');
      const versionInput = qs('#metaVersion');
      const updatedInput = qs('#metaUpdated');
      const hint = qs('#metaSearchHint');

      if (notesInput) {
        notesInput.value = configData.meta?.notes || '';
        notesInput.oninput = (e) => {
          configData.meta = configData.meta || {};
          configData.meta.notes = e.target.value;
        };
      }
      if (versionInput) {
        versionInput.value = configData.version || '';
        versionInput.oninput = (e) => {
          configData.version = e.target.value;
        };
      }
      if (updatedInput) {
        updatedInput.value = configData.updated_at || '';
        updatedInput.oninput = (e) => {
          configData.updated_at = e.target.value;
        };
      }

      if (hint) {
        if (term) {
          hint.textContent = matchesTerm(term, configData.meta?.notes, configData.version, configData.updated_at)
            ? '备注或版本信息匹配当前搜索。'
            : '备注/版本未匹配当前搜索，仍可编辑。';
        } else {
          hint.textContent = '';
        }
      }

      const unitsBox = qs('#metaUnits');
      unitsBox.innerHTML = '';
      const units = configData.meta?.units || {};
      const entries = Object.entries(units).filter(([key, val]) => matchesTerm(term, key, val));
      if (!entries.length) {
        unitsBox.innerHTML = '<div class="small">未找到匹配的单位</div>';
        return;
      }
      entries.forEach(([key, val]) => {
        const row = document.createElement('div');
        row.className = 'flex';
        row.innerHTML = `
          <label style="flex:1">变量<input value="${key}" class="unit-key" /></label>
          <label style="flex:1">单位<input value="${val}" class="unit-val" /></label>
          <button class="danger delete-unit" style="height:40px">删除</button>
        `;
        const keyInput = row.querySelector('.unit-key');
        const valInput = row.querySelector('.unit-val');
        keyInput.addEventListener('change', () => {
          const newKey = keyInput.value.trim();
          if (!newKey) {
            keyInput.value = key;
            return;
          }
          if (newKey !== key && units[newKey]) {
            showStatus('失败', '单位名已存在');
            keyInput.value = key;
            return;
          }
          units[newKey] = units[key];
          delete units[key];
          renderMeta();
        });
        valInput.addEventListener('input', () => {
          units[keyInput.value.trim() || key] = valInput.value;
        });
        row.querySelector('.delete-unit').addEventListener('click', () => {
          delete units[key];
          renderMeta();
        });
        unitsBox.appendChild(row);
      });
    }

    async function saveConfig() {
      if (!configData) return;
      configData.updated_at = new Date().toISOString();
      try {
        const payload = buildServerPayload();
        payload.updated_at = configData.updated_at;
        await fetchJSON(API_PATHS.config, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        showStatus('保存成功', '配置已写入服务器');
        renderOverview();
      } catch (err) {
        showStatus('保存失败', err.message, 4500);
      }
    }

    async function validateConfig() {
      if (!configData) return;
      try {
        const payload = buildServerPayload();
        const resp = await fetchJSON(API_PATHS.validate, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if (resp.ok) {
          showStatus('校验成功', '配置通过校验');
        }
      } catch (err) {
        showStatus('校验失败', err.message, 4500);
      }
    }

    function bindEvents() {
      qs('#reloadBtn').addEventListener('click', loadConfig);
      qs('#validateBtn').addEventListener('click', validateConfig);
      qs('#saveBtn').addEventListener('click', saveConfig);
      qs('#loadVersions').addEventListener('click', loadVersions);
      qs('#addThreshold').addEventListener('click', async () => {
        const result = await openFormModal({
          title: '新增阈值',
          fields: [
            {name: 'label', label: '展示标签', placeholder: '如 极高', required: true},
            {name: 'level', label: '等级', placeholder: '如 5', required: true},
            {
              name: 'min',
              label: '最小值',
              type: 'number',
              required: true,
              step: '0.01',
              parser: (value) => {
                const num = parseFloat(value);
                if (!Number.isFinite(num)) {
                  throw new Error('请输入数字');
                }
                return num;
              }
            }
          ]
        });
        if (!result) return;
        configData.thresholds = configData.thresholds || [];
        configData.thresholds.push({label: result.label, level: result.level, min: result.min});
        renderCalibration();
        showStatus('新增完成', `已添加阈值 ${result.label}`);
      });
      qs('#addUnit').addEventListener('click', async () => {
        const result = await openFormModal({
          title: '新增单位',
          fields: [
            {name: 'key', label: '指标键名', placeholder: '如 angle', required: true},
            {name: 'unit', label: '单位', placeholder: '如 deg', required: true}
          ]
        });
        if (!result) return;
        configData.meta = configData.meta || {};
        configData.meta.units = configData.meta.units || {};
        if (configData.meta.units[result.key]) {
          showStatus('新增失败', `单位 ${result.key} 已存在`);
          return;
        }
        configData.meta.units[result.key] = result.unit;
        renderMeta();
        showStatus('新增完成', `单位 ${result.key}`);
      });
      qs('#addCptEntry').addEventListener('click', async () => {
        const result = await openFormModal({
          title: '新增 CPT 条目',
          fields: [
            {name: 'key', label: 'CPT 键名', placeholder: '如 intent', required: true},
            {
              name: 'body',
              label: '初始内容 (JSON)',
              type: 'textarea',
              value: '{\n  "map": {}\n}',
              parser: (value) => {
                try {
                  return value ? JSON.parse(value) : {};
                } catch (err) {
                  throw new Error(err.message || 'JSON 解析失败');
                }
              }
            }
          ]
        });
        if (!result) return;
        configData.cpt = configData.cpt || {};
        if (configData.cpt[result.key]) {
          showStatus('新增失败', 'CPT 键名已存在');
          return;
        }
        configData.cpt[result.key] = result.body;
        renderCPT();
        showStatus('新增完成', `CPT: ${result.key}`);
      });
      qs('#addRule').addEventListener('click', async () => {
        const result = await openFormModal({
          title: '新增规则',
          fields: [
            {name: 'name', label: '规则名称', placeholder: '如 高威胁意图近距行动', required: true},
            {
              name: 'then',
              label: 'THEN 配置 (JSON)',
              type: 'textarea',
              value: '{\n  "add_score": 0\n}',
              parser: (value) => {
                try {
                  return value ? JSON.parse(value) : {};
                } catch (err) {
                  throw new Error(err.message || 'JSON 解析失败');
                }
              }
            }
          ]
        });
        if (!result) return;
        configData.rules = configData.rules || [];
        configData.rules.push({
          name: result.name,
          if: [],
          then: result.then
        });
        renderRules();
        showStatus('新增完成', `规则 ${result.name}`);
      });
      qs('#addLevel3Group').addEventListener('click', async () => {
        configData.weights = configData.weights || {};
        configData.weights.level3 = configData.weights.level3 || {};
        configData.weights.level2 = configData.weights.level2 || {};
        const parents = getLevel1Parents();
        if (!parents.length) {
          showStatus('新增失败', '请先在 Level2 配置一级分类');
          return;
        }
        let idx = 1;
        let suggest = `new_group_${idx}`;
        while (configData.weights.level3[suggest]) {
          idx += 1;
          suggest = `new_group_${idx}`;
        }
        const result = await openFormModal({
          title: '新增指标组',
          fields: [
            {name: 'key', label: '指标组键名', value: suggest, required: true},
            {
              name: 'parent',
              label: '所属 Level2 父级',
              type: 'select',
              options: parents.map((p) => ({value: p, label: p})),
              value: parents[0],
              required: true
            },
            {
              name: 'weight',
              label: '父级权重',
              type: 'number',
              step: '0.01',
              value: '0',
              parser: (value) => {
                if (value === '' || value === null || value === undefined) return 0;
                const num = parseFloat(value);
                if (!Number.isFinite(num)) {
                  throw new Error('请输入数字');
                }
                return num;
              }
            }
          ]
        });
        if (!result) return;
        const {key, parent, weight} = result;
        if (!parent) {
          showStatus('新增失败', '请选择所属父级');
          return;
        }
        if (configData.weights.level3[key]) {
          showStatus('新增失败', `指标组 ${key} 已存在`);
          return;
        }
        configData.weights.level2[parent] = configData.weights.level2[parent] || {};
        configData.weights.level2[parent][key] = weight ?? 0;
        configData.weights.level3[key] = {};
        renderLevel3();
        renderWeights();
        showStatus('新增完成', `指标组 ${key} 已加入 ${parent}`);
      });

      syncOverrideQueryForm();

      const singleForm = qs('#overrideSingleForm');
      if (singleForm) {
        singleForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const idType = qs('#overrideIdType').value;
          const idRaw = qs('#overrideIdValue').value.trim();
          const threatLevel = qs('#overrideThreatLevel').value.trim();
          const reason = qs('#overrideReason').value.trim();
          const by = qs('#overrideBy').value.trim();
          if (!idRaw) {
            showStatus('校验失败', '请填写标识值');
            return;
          }
          if (!threatLevel) {
            showStatus('校验失败', '请填写威胁等级');
            return;
          }
          const override = {
            threat_level: threatLevel,
            reason,
            by
          };
          override[idType] = idType === 'mbPh' ? maybeNumber(idRaw) : idRaw;
          try {
            await sendOverrideRequest({override}, '单条标注已提交', 'save');
          } catch (err) {
            console.error(err);
          }
        });
      }

      const batchForm = qs('#overrideBatchForm');
      if (batchForm) {
        batchForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const text = qs('#overrideBatchInput').value.trim();
          if (!text) {
            showStatus('校验失败', '请输入批量 JSON 数组');
            return;
          }
          try {
            const parsed = JSON.parse(text);
            const list = Array.isArray(parsed) ? parsed : Array.isArray(parsed.override) ? parsed.override : null;
            if (!Array.isArray(list) || !list.length) {
              showStatus('校验失败', '请输入非空的标注数组');
              return;
            }
            await sendOverrideRequest({override: list}, `批量写入 ${list.length} 条标注`, 'batch');
          } catch (err) {
            showStatus('解析错误', err.message, 4500);
          }
        });
      }

      const deleteForm = qs('#overrideDeleteForm');
      if (deleteForm) {
        deleteForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const idType = qs('#overrideDeleteType').value;
          const idRaw = qs('#overrideDeleteValue').value.trim();
          if (!idRaw) {
            showStatus('校验失败', '请填写要删除的标注标识');
            return;
          }
          const override = {action: 'delete'};
          override[idType] = idType === 'mbPh' ? maybeNumber(idRaw) : idRaw;
          try {
            await sendOverrideRequest({override}, '已请求删除标注', 'delete');
          } catch (err) {
            console.error(err);
          }
        });
      }

      const resetBtn = qs('#overrideResetBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', async () => {
          if (!confirm('确认清空所有标注？')) return;
          try {
            await sendOverrideRequest({reset_overrides: true}, '已请求清空全部标注', 'reset');
          } catch (err) {
            console.error(err);
          }
        });
      }

      const clearLogBtn = qs('#clearOverrideHistory');
      if (clearLogBtn) {
        clearLogBtn.addEventListener('click', () => {
          overrideLog = [];
          renderOverrideHistory();
          showStatus('已清空', '本地标注记录已清空');
        });
      }

      const parseBtn = qs('#parseOverridePreview');
      if (parseBtn) {
        parseBtn.addEventListener('click', () => {
          const text = qs('#overridePreviewInput').value.trim();
          if (!text) {
            overridePreviewData = [];
            renderOverridePreview();
            showStatus('解析完成', '已清空预览结果');
            return;
          }
          try {
            const parsed = JSON.parse(text);
            overridePreviewData = Array.isArray(parsed) ? parsed : [parsed];
            renderOverridePreview();
            showStatus('解析完成', `共 ${overridePreviewData.length} 条结果`);
          } catch (err) {
            showStatus('解析错误', err.message, 4500);
          }
        });
      }

      const statsBtn = qs('#refreshOverrideStats');
      if (statsBtn) {
        statsBtn.addEventListener('click', () => {
          refreshOverrideStats().catch((err) => console.error(err));
        });
      }

      const lookupForm = qs('#overrideLookupForm');
      if (lookupForm) {
        lookupForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const type = qs('#overrideLookupType').value;
          const raw = qs('#overrideLookupValue').value.trim();
          if (!raw) {
            showStatus('校验失败', '请填写要查询的标识');
            return;
          }
          const value = type === 'mbPh' ? maybeNumber(raw) : raw;
          try {
            await lookupOverrideItem(type, value);
          } catch (err) {
            console.error(err);
          }
        });
      }

      const queryForm = qs('#overrideQueryForm');
      if (queryForm) {
        queryForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const level = qs('#overrideQueryLevel').value.trim();
          const by = qs('#overrideQueryBy').value.trim();
          const term = qs('#overrideQueryTerm').value.trim();
          const limitRaw = qs('#overrideQueryLimit').value.trim();
          const offsetRaw = qs('#overrideQueryOffset').value.trim();
          const limitNum = Number(limitRaw);
          const offsetNum = Number(offsetRaw);
          const params = {
            level,
            by,
            q: term,
            limit: limitRaw ? (Number.isFinite(limitNum) ? Math.max(1, limitNum) : '') : '',
            offset: offsetRaw ? (Number.isFinite(offsetNum) ? Math.max(0, offsetNum) : '') : ''
          };
          try {
            await queryOverrideList(params);
          } catch (err) {
            console.error(err);
          }
        });
      }

      const exportBtn = qs('#overrideExportBtn');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          const search = new URLSearchParams();
          if (overrideQueryParams.level) search.set('level', overrideQueryParams.level);
          if (overrideQueryParams.by) search.set('by', overrideQueryParams.by);
          if (overrideQueryParams.q) search.set('q', overrideQueryParams.q);
          if (overrideQueryParams.limit) search.set('limit', overrideQueryParams.limit);
          if (overrideQueryParams.offset || overrideQueryParams.offset === 0) search.set('offset', overrideQueryParams.offset);
          const qsStr = search.toString();
          const url = buildUrl(qsStr ? `${API_PATHS.overrideExport}?${qsStr}` : API_PATHS.overrideExport);
          window.open(url, '_blank');
        });
      }

      const scrollTop = qs('#scrollTopBtn');
      if (scrollTop) {
        scrollTop.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
      }
      const scrollBottom = qs('#scrollBottomBtn');
      if (scrollBottom) {
        scrollBottom.addEventListener('click', () => window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'}));
      }

      attachSearch('#overviewSearch', 'overview', renderOverview);
      attachSearch('#level3Search', 'level3', renderLevel3);
      attachSearch('#cptSearch', 'cpt', renderCPT);
      attachSearch('#rulesSearch', 'rules', renderRules);
      attachSearch('#weightsSearch', 'weights', renderWeights);
      attachSearch('#calibrationSearch', 'calibration', renderCalibration);
      attachSearch('#metaSearch', 'meta', renderMeta);
      attachSearch('#overrideSearch', 'overrides', renderOverrides);

      qsa('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          qsa('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const id = tab.dataset.tab;
          qsa('main section').forEach(sec => sec.classList.remove('active'));
          qs(`#${id}`).classList.add('active');
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      bindEvents();
      loadConfig();
      loadVersions();
      refreshOverrideStats(true).catch((err) => console.error(err));
      queryOverrideList({}, true).catch((err) => console.error(err));
    });
  </script>
</body>
</html>
